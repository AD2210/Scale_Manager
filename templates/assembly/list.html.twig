{% extends 'components/_table_wrapper.html.twig' %}

{% set entityType = 'model' %}
{% set maxAssemblies = 0 %}

{# Calcul du nombre maximum d'assemblages' #}
{% for item in items %}
    {% set itemCount = item.assemblyOperation|length %}
    {% if itemCount > maxAssemblies %}
        {% set maxAssemblies = itemCount %}
    {% endif %}
{% endfor %}

{% block title %}Assemblage{% endblock %}

{% block page_header %}
    <h1 class="h4 mb-0">Assemblage des pièces</h1>
{% endblock %}

{% block table_head %}
    <tr>
        <th class="col-2">Fichier</th>
        {% for i in 1..maxAssemblies %}
            <th class="col-2">Assemblage {{ i }}</th>
            <th class="text-center col-1">Terminé</th>
        {% endfor %}
        <th class="col-2">Nouveau</th>
    </tr>
{% endblock %}

{% block table_rows %}
    {% for item in items %}
        <tr data-id="{{ item.id }}">
            {% include 'components/_text_readonly.html.twig' with {
                value: item.fileName
            } %}

            {# Assemblage existants triés par ordre de création #}
            {% set operations = item.assemblyOperation|sort((a, b) => a.id <=> b.id) %}

            {% for i in 1..maxAssemblies %}
                {% set operation = operations[i - 1] is defined ? operations[i - 1] : null %}

                {% include 'components/editable/_dropdown_cell.html.twig' with {
                    entityId: item.id,
                    entityType: entityType,
                    field: 'assemblyProcess',
                    name: 'assemblyOperation-' ~ i,
                    value: operation ? {
                        id: operation.id,
                        name: operation.assemblyProcess.name,
                        assemblyProcessId: operation.assemblyProcess.id
                    } : null,
                    items: assemblyProcesses,
                    multiple: false,
                    placeholder: 'Aucun Assemblage',
                    disabled: operation is null and i > operations|length + 1
                } %}

                {% include 'components/editable/_checkbox_cell.html.twig' with {
                    value: operation ? operation.isDone : false,
                    field: 'isDone',
                    entityId: operation ? operation.id : null,
                    entityType: 'assemblyOperation',
                    disabled: operation is null
                } %}
            {% endfor %}

            {# Colonne "Nouvel assemblage" #}
            {% include 'components/editable/_dropdown_cell.html.twig' with {
                entityId: item.id,
                entityType: entityType,
                field: 'assemblyProcess',
                name: 'assemblyOperation-new',
                value: null,
                items: assemblyProcesses,
                multiple: false,
                placeholder: 'Ajouter un assemblage'
            } %}
            <td></td>
        </tr>
    {% endfor %}
{% endblock %}
